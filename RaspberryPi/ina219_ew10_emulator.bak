#!/usr/bin/env python3
import socket, time, random

HOST = "0.0.0.0"     # Listen on all interfaces
PORT = 8899          # Same as Elfin EW10
print(f"üì° INA219 EW10 emulator listening on {HOST}:{PORT}")

server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
server.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
server.bind((HOST, PORT))
server.listen(1)

while True:
    print("‚è≥ Waiting for Signal K to connect...")
    conn, addr = server.accept()
    print(f"‚úÖ Connection from {addr}")

    try:
        while True:
            # Example dummy INA219 readings (replace with real values)
            volt = round(12.0 + random.uniform(-0.05, 0.05), 3)
            curr = round(0.5 + random.uniform(-0.05, 0.05), 3)
            power = round(volt * curr, 3)

            sentences = [
                f"$IIXDR,A,{volt},V,INA1,VOLT*00\r\n",
                f"$IIXDR,A,{curr},A,INA1,CURR*00\r\n",
                f"$IIXDR,A,{power},W,INA1,POWR*00\r\n"
            ]

            for s in sentences:
                conn.sendall(s.encode())
                time.sleep(0.3)

            time.sleep(1.5)
    except (BrokenPipeError, ConnectionResetError):
        print("‚ö†Ô∏è Signal K disconnected ‚Äî restarting loop...")
        conn.close()
        time.sleep(1)
        continue
